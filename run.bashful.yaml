x-reference-data:
  all-apps: &app-names
    - $include fs-list.yaml
  fio-tests: &fio-tests
    - $include fio-tests-list.yaml

config:
  max-parallel-commands: 10

tasks:
  - name: Benchmarking filesystems
    parallel-tasks:
      - name: "Run test for <replace>"
        cmd: |
          cp __test_template.sh <replace>/test_template.sh && \
          cp __test_template_env.sh <replace>/test_template_env.sh && \
          cp __fio-job.cfg <replace>/fio-job.cfg && \
          cd <replace> && \
          bash run.sh
        for-each: *app-names
  - name: Copy fio logs
    parallel-tasks:
      - name: "copy logs for <replace>"
        cmd: |
          mkdir -pv build/fio/logs
          cd <replace>/out/fio && \
          for i in *.log ; do cp $i ../../../build/fio/logs/<replace>_$i ; done
        for-each: *app-names
  - name: Generate gnuplot rendering scripts for fio
    parallel-tasks:
      - name: "Script for <replace>"
        cmd: |
          cd build/fio/logs && \
          rm -rfv ../gnuplot/ && \
          fio2gnuplot -t <replace> -d ../gnuplot -p '*<replace>_bw*.log' -v
        for-each: *fio-tests
  - name: Create graphs
    cmd: python graphs.py
